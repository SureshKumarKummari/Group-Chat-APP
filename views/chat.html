<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Bootstrap  icons -->

    <link rel="stylesheet" href="./style.css" />
</head>

<hr>
<h1 class=" rounded" style="text-align:center;">Welcome To Group Chat
</h1>
<hr>

<body>

    <div class="container-fluid" style="height: 100vh;">
        <div class="row" style="height: 100%;">

            <div id="sidebar" class="col-3 justify-content-start rounded" style="background-color: grey;">
                <div class="sidebar list-group" style="width: 100%;">
                    <!-- For search functionality <div class="row">
                        <div class="col-8">
                    <input type="text" class="form-control" placeholder="Type user/group name"/>
                    </div>
                    <div class="col-4" style="overflow:hidden;">
                        <button class="form-control" >Search</button>
                    </div>
                    </div> -->
                    <hr>
                    <ul class="list-group" style="width: 100%;" id="usersandgroups">
                        <li>
                    <div class="d-flex" style="overflow:hidden;">
                        <div class="col-4" style="color:rgb(0, 187, 255)">
                            <button class="avatar" onclick="showuserinfo(event)">
                                <img src="./user.jpg" alt="avatar">
                            </button>
                            <div class="hidden-window" id="hidden">
                                
                                
                            </div>
                        </div>
                        <div class="col-4" style="margin-left: 5px;">
                            <button class="rounded-5" onclick="showuserform(event)">
                                create group
                            </button>
                            <div class="hidden-window-form" id="hidden-form">
                            
                            
                            </div>
                        </div>
                        <div class="col" style="margin-left: 5px;">
                            <button class="rounded-5" onclick="showlinkstojoingroup(event)">
                                Join group
                            </button>
                            <div class="hidden-window-join" id="hidden-join">
                            <h6>No invitations to join Group</h6>
                        
                            </div>
                        </div>
                    </div>
                    </li>
                        <hr>
                        <!-- get groups nd add here as list elements-->

                    </ul>
                </div>
            </div>


            <div class="col-8" style="display:none;" id="changecol">
                <div class="container">
                    <!-- msg-header section starts -->
                    <div id="header">
                       
                    </div>
                    <!-- msg-header section ends -->

                    <div class="chat-page">
                        <div class="msg-inbox">
                            <div class="chats">
                                <!-- Message container -->
                                <div class="msg-page" id="msg-page">

                                    <!-- Outgoing and received messages -->
                                </div>
                            </div>

                            <!-- msg-bottom section -->
                            <div class="msg-bottom">
                                <div class="input-group">
                                    <input type="text" id="message" class="form-control"
                                        placeholder="Type message..." />

                                    <button class="btn" onclick="handleSubmit()">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                            </div>

                            </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
   
</body>
<script src="../node_modules/socket.io/client-dist/socket.io.js"></script>
<script>
    function saveuserinfo(){
        let d=document.getElementById('hidden');
            let usernameP = document.createElement('p');
            let emailP = document.createElement('p');
            let phoneP = document.createElement('p');
        
            // Set the text content of each p element to the corresponding data field
            usernameP.textContent = "Username: " + localStorage.getItem('username');
            emailP.textContent = "Email: " + localStorage.getItem('email');
            phoneP.textContent = "Phone: " + localStorage.getItem('phone');
            // Append the p elements to the d element
            d.appendChild(usernameP);
            d.appendChild(emailP);
            d.appendChild(phoneP);

    }

    saveuserinfo();

//displaying user-data hidden window
    function showuserinfo(event){
            let parentLi = event.target.closest('li');

            let hiddenWindow = parentLi.querySelector('.hidden-window');
            // Toggle the active class of the hidden window
            hiddenWindow.classList.toggle('active');
    }

    //showing userform - for adding new group

    function showuserform(event){
        let div = event.target.closest('div');
        let hiddenWindow = div.querySelector('.hidden-window-form');
        // Toggle the active class of the hidden window
        hiddenWindow.classList.toggle('active');
    }

    function showlinkstojoingroup(event){
        let div = event.target.closest('div');
        let hiddenWindow = div.querySelector('.hidden-window-join');
       // console.log(hiddenWindow);
        // Toggle the active class of the hidden window
        hiddenWindow.classList.toggle('active');
    }



//to select chat with different person or group
    function handlechat(buttonElement) {

        let chatwindow = document.getElementById('changecol');
        if (chatwindow.style.display == 'none') {
            chatwindow.style.display = 'block';
            //console.log(chatwindow.style.display);
        }
        // Access the img and h6 elements inside the button
        let imgElement = buttonElement.querySelector('img');
        let h6Element = buttonElement.querySelector('h6');
        let hiddenElement = buttonElement.querySelector('input[type="hidden"]');
        //console.log(hiddenElement.value);
        const hiddenvalue=hiddenElement.value;
        // Get the image source
        let imageUrl = imgElement.getAttribute('src');

        // Get the username from the h6 element
        let username = h6Element.textContent;

        // Clear the header contents
        let header = document.getElementById('header');
        header.innerHTML = "";

        // Create elements
        let msgHeaderDiv = document.createElement('div');
        msgHeaderDiv.classList.add('msg-header');

        let container1Div = document.createElement('div');
        container1Div.classList.add('container1');

        let col2Div = document.createElement('div');
        col2Div.classList.add('col-2');

        let img = document.createElement('img');
        img.src = imageUrl;
        img.alt = 'avatar';
        img.classList.add('msgimg');

        let activeDiv = document.createElement('div');
        activeDiv.classList.add('active');
        let p = document.createElement('p');
        p.textContent = username;
        activeDiv.appendChild(p);

        // Append elements
        container1Div.appendChild(col2Div);
        container1Div.appendChild(img);
        container1Div.appendChild(activeDiv);
        msgHeaderDiv.appendChild(container1Div);
        header.appendChild(msgHeaderDiv);
        localStorage.setItem('currentreceiverorgroup',hiddenvalue);
        displaychat(hiddenvalue)

    }


    function addreceivedMessage(message) {

        let d = document.getElementById('msg-page');

        // Create the necessary DOM elements
        let receivedChatsDiv = document.createElement('div');
        receivedChatsDiv.classList.add('received-chats');

        let receivedChatsImgDiv = document.createElement('div');
        receivedChatsImgDiv.classList.add('received-chats-img');

        let img = document.createElement('img');
        img.setAttribute('src', './user.jpg');

        let receivedMsgDiv = document.createElement('div');
        receivedMsgDiv.classList.add('received-msg');

        let receivedMsgInboxDiv = document.createElement('div');
        receivedMsgInboxDiv.classList.add('received-msg-inbox');

        let p = document.createElement('p');
        p.classList.add('single-msg');
        p.textContent = message;

        let span = document.createElement('span');
        span.classList.add('time');
        span.textContent = '18:31 PM | July 24';

        // Append the elements to the appropriate parent elements
        receivedMsgInboxDiv.appendChild(p);
        receivedMsgInboxDiv.appendChild(span);

        receivedMsgDiv.appendChild(receivedMsgInboxDiv);

        receivedChatsImgDiv.appendChild(img);

        receivedChatsDiv.appendChild(receivedChatsImgDiv);
        receivedChatsDiv.appendChild(receivedMsgDiv);

        // Append the whole structure to the target element
        d.appendChild(receivedChatsDiv);

    }


    function addSentMessage(message) {
        let d = document.getElementById('msg-page');

        // Create the necessary DOM elements
        let outgoingChatsDiv = document.createElement('div');
        outgoingChatsDiv.classList.add('outgoing-chats');

        let outgoingChatsImgDiv = document.createElement('div');
        outgoingChatsImgDiv.classList.add('outgoing-chats-img');

        let img = document.createElement('img');
        img.setAttribute('src', './user.jpg');

        let outgoingMsgDiv = document.createElement('div');
        outgoingMsgDiv.classList.add('outgoing-msg');

        let outgoingMsgInboxDiv = document.createElement('div');
        outgoingMsgInboxDiv.classList.add('outgoing-chats-msg');

        let p = document.createElement('p');
        p.classList.add('multi-msg');
        p.textContent = message;

        let span = document.createElement('span');
        span.classList.add('time');
        span.textContent = '18:30 PM | July 24';

        // Append the elements to the appropriate parent elements
        outgoingMsgInboxDiv.appendChild(p);
        outgoingMsgInboxDiv.appendChild(span);

        outgoingMsgDiv.appendChild(outgoingMsgInboxDiv);

        outgoingChatsImgDiv.appendChild(img);

        outgoingChatsDiv.appendChild(outgoingChatsImgDiv);
        outgoingChatsDiv.appendChild(outgoingMsgDiv);

        // Append the whole structure to the target element
        d.appendChild(outgoingChatsDiv);


    }

//Adding users and groups to sidebar
    function addUsersandGroups(data,isgroup){
        let ul=document.getElementById('usersandgroups');

            let li = document.createElement('li');
            li.classList.add('list-group-item');

            // Create the button element
            let button = document.createElement('button');
            button.classList.add('btn', 'd-flex', 'align-items-center');
            button.setAttribute('onclick', 'handlechat(this)');

            // Create the div elements for avatar and user details
            let avatarDiv = document.createElement('div');
            avatarDiv.classList.add('col-2');
            avatarDiv.style.paddingRight="30px";
            let userDiv = document.createElement('div');
            userDiv.classList.add('col');//col

            // Create the avatar image
            let avatarImg = document.createElement('img');
            if(isgroup){
                avatarImg.setAttribute('src', './group.jpg');
            }else{
            avatarImg.setAttribute('src', './user.jpg');
            }
            avatarImg.setAttribute('alt', 'avatar');
            avatarDiv.appendChild(avatarImg);

            // Create the user name element
            let userName = document.createElement('h6');
            userName.textContent = data.username;
            userDiv.appendChild(userName);

            // Create the hidden input field for user ID
            let hiddenInput = document.createElement('input');
            hiddenInput.setAttribute('type', 'hidden');
            hiddenInput.setAttribute('name', 'hiddenid');
            hiddenInput.setAttribute('value', data.user_id);

            // Append the div elements to the button
            button.appendChild(avatarDiv);
            button.appendChild(document.createElement('div')); // Placeholder for col-2
            button.appendChild(userDiv);
            button.appendChild(hiddenInput); // Append the hidden input field

            // Append the button to the li element
            li.appendChild(button);

            // Append the li element to the ul
            ul.appendChild(li);
    }
    let userid = localStorage.getItem('userid');
    const socket = io('http://localhost:4000', {
            query: {
                userid: Number(userid)
            }
        });


    function handleSubmit() {
        const message = document.getElementById('message').value;

        let receiverid=localStorage.getItem('currentreceiverorgroup');
        //console.log(receiverid);
        let senderid = localStorage.getItem('userid');
        //console.log(receiverid,senderid);
        socket.emit('joinRoom',Number(receiverid));
        socket.emit('message', {senderid,receiverid,message});
        addSentMessage(message);
    }

    function getusersdata() {
        let userid=localStorage.getItem('userid');
        socket.emit('getusersdata', userid);
    }

     socket.on('usersdata', (data) => {
            //console.log(data.users,data.groups);
            for (let i = 0; i < data.users.length; i++) {
                if(data.users[i].user_id!=localStorage.getItem('userid')) {
                addUsersandGroups(data.users[i],false);
                }
            }
            //console.log(data.groups,data.users);
            for (let i = 0; i < data.groups.length; i++) {
                 addUsersandGroups(data.groups[i],true);
            }

        })

    getusersdata();
    
    socket.on('message', (data) => {
        //console.log('Received message:', data);
        addreceivedMessage(data);
    });

    function displaychat(receiverid) {
            let d = document.getElementById('msg-page');
            d.innerHTML="";
            let userid = localStorage.getItem('userid')
            socket.emit('getcurrentchat', { receiverid, userid });
        }
    
        socket.on('currentchat',(data)=>{
            let uid=localStorage.getItem('userid');
            for(let i=0;i<data.length;i++){
             if(data[i].senderId==uid){
              addSentMessage(data[i].content);
             }else{
              addreceivedMessage(data[i].content);
             }
            }

        })

        //Adding links to join groups to hidden window

        function getlinkstojoin(){
            let userid = localStorage.getItem('userid');
            socket.emit('getlinkstojoin',userid);
        }

        getlinkstojoin();

        socket.on('linkstojoin',(data)=>{
           // console.log(data);
            if(data.length!=0){
                let div=document.getElementById('hidden-join');
                div.innerHTML ="";
                div.innerHTML=`<h6>Click on group which you want to join</h6>`;
                for(let i=0;i<data.length;i++){
                    addlinkstohidden(data[i],div);
        
                }
            }
        })

        function addlinkstohidden(data,div){
            var button = document.createElement("button");
           // console.log(data);
            // Create an image element
            var img = document.createElement("img");
            img.src = "./group.jpg"; // Set image URL
            img.alt = "Group Image"; // Add alt text for accessibility
            button.appendChild(img); // Append image
            button.classList.add("btn");
            button.classList.add("btn-primary");
            button.style.width="100%";

            // Create a hidden input element for group_id
            var hiddenInput = document.createElement("input");
            hiddenInput.type = "hidden";
            hiddenInput.name = "group_id"; // Set the name attribute
            hiddenInput.value = data.group_id; // Set the value
            button.appendChild(hiddenInput); // Append hidden input to the button

            var groupName = document.createTextNode(data.group_name);
            button.appendChild(groupName);

            // Add onclick event handler
            button.onclick = function () {
                handlejoinClick(button);
            };

            div.appendChild(button);
        }



        function handlejoinClick(button){
            var hiddenInput = button.querySelector('input[name="group_id"]');
            // Get the value of the hidden input element (group_id)
            var groupId = hiddenInput.value;
            let username=button.textContent;
            button.remove();
            //console.log(groupId);
            socket.emit('addtogroup',groupId);

            socket.on('okaddgroup',(groupid)=>{
                let data={username:username,uer_id:groupid}
                //console.log(data);
                addUsersandGroups(data, true);
                
                //username, user_id-groupid
            });

        }


//Message typing events
  //  const messageInput = document.getElementById('message');
   // let typingTimeout;
//
  //  messageInput.addEventListener('input', () => {
    //    clearTimeout(typingTimeout);
      //  socket.emit('typing');
       // typingTimeout = setTimeout(() => {
        //    socket.emit('stop typing');
        //}, 1000);
    //});


//getallusersdata for hidden-window-form and addind usersdata for hidden-window
    function getallusersdata() {
            let userid = localStorage.getItem('userid');
            socket.emit('getallusers', userid);
        }

    getallusersdata();

        socket.on('allusers', (data) => {
            adduserstoform(data);
            })


        function adduserstoform(data) {

            let div = document.getElementById('hidden-form');
            div.innerHTML = ''; // Clear the div contents

            // Create the form element
            let form = document.createElement('form');
            form.setAttribute('onsubmit', 'handlecreateGroup(event)'); // Add onsubmit attribute
            // Create the text field for the group chat name
            let groupNameInput = document.createElement('input');
            groupNameInput.setAttribute('type', 'text');
            groupNameInput.setAttribute('placeholder', 'Enter group chat name');
            groupNameInput.setAttribute('name', 'group-name');
            form.appendChild(groupNameInput);
            form.appendChild(document.createElement('br')); // Line break

            // Loop through the data array to create checkboxes
            for (let i = 0; i < data.length; i++) {
                let userData = data[i];

                // Create the checkbox element
                let checkbox = document.createElement('input');
                checkbox.setAttribute('type', 'checkbox');
                checkbox.setAttribute('name', 'user');
                checkbox.setAttribute('value', userData.username);
                // Create the label for the checkbox (displaying the username)
                let label = document.createElement('label');
                label.textContent = userData.username;
                // Create the hidden element to store the user_id
                let hiddenInput = document.createElement('input');
                hiddenInput.setAttribute('type', 'hidden');
                hiddenInput.setAttribute('name', 'user-id');
                hiddenInput.setAttribute('value', userData.user_id);
                // Append the checkbox, label, and hidden input to the form
                form.appendChild(checkbox);
                form.appendChild(label);
                form.appendChild(hiddenInput);
                form.appendChild(document.createElement('br')); // Line break
            }

            // Create the button to create the group
            let createGroupButton = document.createElement('button');
            createGroupButton.textContent = 'Create Group';
            createGroupButton.setAttribute('type', 'submit');

            // Append the button to the form
            form.appendChild(createGroupButton);

            // Append the form to the div
            div.appendChild(form);

        }


        function handlecreateGroup(event){
             let hiddenWindow = document.querySelector('.hidden-window-form');
            // Toggle the active class of the hidden window
            hiddenWindow.classList.toggle('active');
            event.preventDefault();
                let form = event.target;
               // Get the group name from the input field
                let groupName = form.querySelector('input[name="group-name"]').value;
                // Get all checked checkboxes for users
                let checkedCheckboxes = form.querySelectorAll('input[type="checkbox"]:checked');
                // Initialize arrays to store user names and their corresponding user IDs
                let selectedUsers = [];
                let selectedUserIds = [];
                // Loop through checked checkboxes to gather user data
                checkedCheckboxes.forEach(function (checkbox) {
                    // Get the label associated with the checkbox (which contains the username)
                    let label = checkbox.nextElementSibling;
                    // Get the hidden input element containing the user ID
                    let hiddenInput = label.nextElementSibling;
                    // Push username and user ID to respective arrays
                    selectedUsers.push(label.textContent);
                    selectedUserIds.push(hiddenInput.value);
                });

                form.reset();
                socket.emit("creategroup",{groupName,selectedUsers,selectedUserIds});
                socket.on('groupcreated',(data)=>{
                    addUsersandGroups(data, true);
                
                });
        }

</script>

</html>